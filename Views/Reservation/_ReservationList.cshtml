@using X.PagedList
@using X.PagedList.Mvc.Core
@using HotelRoomReservationSystem.Models.ViewModels
@model IPagedList<ReservationListViewModel>


@{
    ViewData["Title"] = "Reservations";
    string[] fields = new string[] { "ReservationId", "UserName", "UserEmail", "RoomName", "CheckInDate", "CheckOutDate", "TotalPrice", "Status" };
}

<!--THis two hidden form it relevent to ReserveManage.cshtml id="searchForm"-->
@Html.Hidden("sort", ViewBag.Sort, new { form = "searchForm" })
@Html.Hidden("dir", ViewBag.Dir, new { form = "searchForm" })
@Html.Hidden("page", Model.PageNumber, new { form = "searchForm" })
@Html.Hidden("pageSize", ViewBag.PageSize, new { form = "searchForm" })
@Html.Hidden("searchBar", ViewBag.Name, new { form = "searchForm" })
@Html.Hidden("status", ViewBag.Status, new { form = "searchForm" })

<!-- Reservation Table -->
@if (Model?.Any() == true)
{
    <table class="data-table">
        <thead>
            <tr class="no-hover">
                @if (Model.Any(r => r.Status == "Pending"))
                {
                    <th><input id="selectAll" class="input checkbox all" type="checkbox" /></th>
                }
                else
                {
                    <th></th>
                }
                @foreach (var searchForm in fields)
                {
                    string d = "asc";
                    string c = "";

                    if (searchForm == ViewBag.Sort)
                    {
                        d = ViewBag.Dir == "des" ? "asc" : "des";
                        c = ViewBag.Dir;
                    }


                    <th class="sortable">
                        <a href="?searchBar=@ViewBag.Name&sort=@searchForm&dir=@d&pageSize=@ViewBag.PageSize&page=@Model.PageNumber"
                           data-ajax="true"
                           data-ajax-update="#target"
                           data-ajax-loading="#loader"
                           class=" @c"
                           id="sort-link">
                            @searchForm
                        </a>
                    </th>
                }
            </tr>
        </thead>

        <tbody>
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="10" style="text-align:center;">No results found</td> <!-- 10 is the number of columns in the table -->
                </tr>
            }
            else
            {
                @foreach (var (itemRecord, index) in Model.Select((reservation, index) => (reservation, index)))
                {
                    <tr class="data-row"
                        data-reservationId="@itemRecord.ReservationId" data-status="@itemRecord.Status">
                        <td>
                            @if (itemRecord.Status == "Pending")
                            {
                                <input class="input checkbox" type="checkbox" data-reservationId="@itemRecord.ReservationId" />
                            }
                        </td>
                        <td>@itemRecord.ReservationId</td>
                        <td>@itemRecord.UserName</td>
                        <td>@itemRecord.UserEmail</td>
                        <td>@itemRecord.RoomName</td>
                        <td>@itemRecord.CheckInDate?.ToString("yyyy-MM-dd")</td>
                        <td>@itemRecord.CheckOutDate?.ToString("yyyy-MM-dd")</td>
                        <td>RM @itemRecord.TransactionAmount.ToString("N2")</td>
                        <td id="status">
                            <button type="button" class="status-btn" style="background-color: @(itemRecord?.Status == "Pending" ? "#ffc107" : (itemRecord?.Status == "Completed" ? "#28a745" : "#dc3545"));color: white;">
                                @itemRecord.Status
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>







    </table>


}
else
{
    <h1 style="color:black; display:flex;justify-content:center;">No reservations available.</h1>
}


@* <p> *@
@*     @Model.Count() of @Model.TotalItemCount record(s) | *@
@*     Page @Model.PageNumber of @Model.PageCount *@
@* </p> *@

@{
    int currentPage = Model.PageNumber;
    int totalPages = Model.PageCount;
    string previousPageUrl = currentPage > 1
        ? $"?searchBar={ViewBag.Name}&sort={ViewBag.Sort}&dir={ViewBag.Dir}&page={currentPage - 1}&pageSize={ViewBag.PageSize}&status={ViewBag.Status}"
        : null;
    string nextPageUrl = currentPage < totalPages
        ? $"?searchBar={ViewBag.Name}&sort={ViewBag.Sort}&dir={ViewBag.Dir}&page={currentPage + 1}&pageSize={ViewBag.PageSize}&status={ViewBag.Status}"
        : null;

    var ajaxOptions = new AjaxOptions
            {
                HttpMethod = "get",
                UpdateTargetId = "target",
                LoadingElementId = "loader"
            };
}


@if (totalPages != 0)
{
    <section class="flex items-center justify-between" style="margin-top:3rem">
        <!-- Displaying current range of items -->
        <small class="muted">
            @((currentPage - 1) * Model.PageSize + 1) -
            @(Math.Min(currentPage * Model.PageSize, Model.TotalItemCount)) /
            @Model.TotalItemCount items
        </small>

        <div class="flex gap-2 items-center">
            <div class="flex gap-05 items-center">
                <form data-ajax="true"
                      data-ajax-update="#target"
                      data-ajax-loading="#loader"
                      class="flex items-center gap-05">
                    <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                    <input class="input number small"
                           type="number"
                           name="page"
                           min="1"
                           max="@totalPages"
                           value="@currentPage"
                           onchange="$(this.form).submit();"
                           required />
                    <small class="muted">/</small>
                    <small class="muted">@totalPages pages</small>
                </form>
            </div>

            <div class="flex gap-05 items-center">
                <!-- Previous button -->
                @if (!string.IsNullOrEmpty(previousPageUrl))
                {
                    <a href="@previousPageUrl"
                       data-ajax="true"
                       data-ajax-update="#target"
                       data-ajax-loading="#loader"
                       class="button icon link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#247783" viewBox="0 0 256 256">
                            <path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path>
                        </svg>
                    </a>
                }
                else
                {
                    <button class="button icon link" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#d3d3d3" viewBox="0 0 256 256">
                            <path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path>
                        </svg>
                    </button>
                }

                <!-- Next button -->
                @if (!string.IsNullOrEmpty(nextPageUrl))
                {
                    <a href="@nextPageUrl"
                       data-ajax="true"
                       data-ajax-update="#target"
                       data-ajax-loading="#loader"
                       class="button icon link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#247783" viewBox="0 0 256 256">
                            <path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path>
                        </svg>
                    </a>
                }
                else
                {
                    <button class="button icon link" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#d3d3d3" viewBox="0 0 256 256">
                            <path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path>
                        </svg>
                    </button>
                }
            </div>
        </div>
    </section>
}